# 稀疏多波前分解专用控制与数据路径 IP  
（毕设配套专利规划草案）

> 面向稀疏多波前分解（Multifrontal / Supernodal LU/Cholesky）的  
> **“HPU + ATU + 硬件调度器 + Panel/TRSM/TPU 流水”整体电路方案**

---

## 1. 发明名称（暂定）

> **一种面向稀疏多波前分解的主元选择、地址重映射与前沿任务硬件调度电路**

（后续可以根据导师/专利代理人的建议再微调措辞）

---

## 2. 技术领域

本发明属于**集成电路与高性能计算**技术领域，特别涉及一种用于  
稀疏线性方程组求解器（如多波前 LU/Cholesky 分解）的  
**专用控制与数据路径 IP 核**，适用于 FPGA/ASIC 等可编程或专用芯片中。

---

## 3. 背景技术与现有问题（写概要，专利时再扩展）

1. 稀疏矩阵在科学计算、机器学习、网络分析等场景中广泛存在，  
   其多波前分解（Multifrontal / Supernodal）常通过一棵消去树来组织计算。

2. 现有通用处理器或 GPU/TPU：
   - **主元选择（pivoting）通常在软件中完成**，引入大量分支与随机访存；
   - 行交换往往通过真实搬移行数据实现，导致访存带宽和延迟开销巨大；
   - 稀疏结构不规则，难以充分利用张量阵列（TPU / systolic array）的吞吐率。

3. 现有稀疏求解加速器：
   - 多将注意力集中在稠密块计算（GEMM/SpMV）上，  
     对“主元选择 + 行置换 + 前沿任务调度”部分仍依赖软件或简单控制逻辑；
   - 缺乏一套**系统性的、针对多波前分解**的专用控制与地址重映射电路。

> 综上，缺少一种 **专门针对多波前分解**，既能支持灵活主元策略、  
> 又能避免大规模行搬移、同时理解消去树依赖关系的**硬件控制与数据路径方案**。

---

## 4. 发明内容概述（本专利“包含哪些”）

本发明提出一种面向稀疏多波前分解的专用 IP 核，将以下几部分  
**在硬件上紧密耦合**并统一调度：

1. **HPU（Hybrid Pivot Unit）混合主元选择单元**
   - 在同一硬件中支持至少两种主元策略：
     - **CALU 模式**：优先并行度的块级/面板主元选择；
     - **Threshold 模式**：基于阈值的主元搜索，优先减少填充值；
   - 利用树形归约/比较网络，实现流式输入下的高吞吐主元选择。

2. **ATU（Address Translation Unit）地址变换与零拷贝行置换单元**
   - 维护逻辑行号到物理存储地址/偏移的 **P-Vector 映射表**；
   - 对外暴露“虚拟行号”接口：内核只使用逻辑行号访问矩阵；
   - 当 HPU 决定两行置换时，ATU **只更新 P-Vector**，无需真实搬移行数据；
   - 支持流水化地址翻译，使 Panel/TRSM/TPU 能在单周期内获取物理地址。

3. **Front 级硬件调度器（Front Scheduler / Wavefront Scheduler）**
   - 接收由软件预处理产生的 **消去树/Front DAG** 与任务描述符（Task Descriptor）；
   - 维护 Front 的依赖关系与就绪队列，实现多波前调度：
     - 父 Front 完成后自动激活子 Front；
     - 根据资源占用与模式（CALU/Threshold）动态发射 Front 任务；
   - 统一为每个 Front 配置 HPU 模式、ATU P-Vector 起始地址、面板参数等。

4. **内核流水控制器（Kernel Pipeline Controller）**
   - 对 Panel-GEPP、TRSM、TPU/GEMM 等内核进行 **5 级流水 / 多级流水**控制；
   - 管理本地 SRAM 双缓冲/多缓冲，  
     在 Front 之间以及 Panel/TRSM/GEMM 阶段之间形成高度重叠的数据流；
   - 与 HPU/ATU 协同，在 pivot 事件和地址映射更新过程中保持流水不断流。

5. **外设/系统接口**
   - 与 Host（CPU/GPU）之间通过指令/任务队列交互；
   - 与外部存储（DDR/SRAM）和张量阵列（TPU/systolic array）之间通过  
     标准或定制总线协议交互（AXI、AXI-Stream 等）。

> 整体而言，本专利覆盖一个完整的 **“控制+地址+调度” IP 子系统**，  
> 不是单纯一块乘加阵列，而是一套支撑稀疏多波前分解的 **控制中枢电路**。

---

## 5. 核心模块详细说明（专利撰写方向）

### 5.1 HPU：混合主元选择单元

- **功能**  
  - 接收来自面板数据流的元素值及行/列索引；
  - 根据 `mode` 选择不同的主元策略：
    - CALU：在一个 panel 子块中寻找最大主元；
    - Threshold：寻找满足阈值条件的第一个/若干主元；
  - 输出主元行号、主元值及相关标志。

- **结构要点**  
  - 树形比较与归约网络；
  - 可配置阈值寄存器组；
  - 支持 streaming 输入与流水输出；
  - Mode 控制与早停策略。

- **专利可点**  
  - 在单一硬件单元中集成多种 pivot 策略，并与后端流水 tightly-coupled。

---

### 5.2 ATU：基于 P-Vector 的地址变换与零拷贝行置换

- **功能**
  - 存储逻辑行号的 P-Vector 映射；
  - 接收逻辑行号请求，输出对应的物理地址或偏移；
  - 响应 HPU 产生的 pivot 事件，更新 P-Vector 中相关条目；
  - 保证更新期间内核访问得到一致的地址翻译结果。

- **结构要点**
  - P-Vector 存储：可用 SRAM/寄存器堆实现；
  - 支持随机读写与流水式查询；
  - 必要时采用双缓冲/版本号机制解决并发读写冲突；
  - 与内核的数据总线及控制总线的对接逻辑。

- **专利可点**
  - 通过逻辑行号重映射实现“零拷贝 pivot 行交换”，  
    在硬件上避免真实行搬移带来的访存开销。

---

### 5.3 Front 级硬件调度器

- **功能**
  - 维护 Front 之间的依赖关系（消去树 / DAG）；
  - 追踪每个 Front 父节点完成情况，决定何时进入 ready 队列；
  - 根据资源（内核空闲、SRAM buffer 可用、HPU/ATU 带宽等）  
    和 Front 属性（CALU/Threshold）决定发射顺序；
  - 为每个 Front 生成执行脚本：Panel → TRSM → GEMM 的阶段序列配置。

- **结构要点**
  - Front 描述符存储（Task Descriptor FIFO / RAM）；
  - 依赖计数器（pending_parents）与子节点列表；
  - Ready 队列与 Issue 选择策略；
  - 对 HPU/ATU、Pipeline Controller 的配置与握手接口。

- **专利可点**
  - 把 **多波前分解的 DAG 结构直接下放到硬件调度器**，  
    与 HPU/ATU 协同，实现特定于该算法的并行调度与资源分配。

---

### 5.4 内核流水控制器（Panel/TRSM/TPU Pipeline）

- **功能**
  - 管理 Panel-GEPP、TRSM、TPU/GEMM 的多级流水；
  - 控制本地 SRAM 的装载、复用与双缓冲切换；
  - 通过 valid/ready 信号协调各 kernel 与 HPU/ATU 的交互；
  - 提供事件反馈给 Front Scheduler（例如 Front 完成、异常标志）。

- **结构要点**
  - 状态机或 scoreboard 结构跟踪每个阶段的 busy/idle 状态；
  - 对内核的启动、暂停、刷写控制；
  - 与 ATU 地址翻译逻辑的时序对接。

- **专利可点**
  - 本控制器针对“Front 任务 + HPU/ATU + 多 kernel”的特定数据流设计，  
    与通用 CPU/GPU 调度逻辑在结构与接口上有实质区别。

---

### 5.5 外围接口与系统部署方式（可作为从属权利要求）

- 与 Host 的任务队列/寄存器接口；
- 与外部存储（DDR）的读写接口配置方式；
- 与张量阵列（TPU/systolic array）的数据路径与控制信号定义；
- 在 FPGA/ASIC 中的集成方式（单独 IP 或 SoC 子系统）。

---

## 6. 为了支撑这个专利，你“需要做什么”——实现与实验计划

下面是面向毕设+专利的 **工程任务清单**，可以直接当 roadmap 用。

### 6.1 核心 RTL/HLS 实现任务

1. **实现独立可仿真的 HPU 模块**
   - 接口：数据流 + mode + 阈值；输出 pivot 行与标志；
   - 覆盖 CALU/Threshold 两种模式；
   - 写 testbench，对照 Python/Matlab 的 pivot 结果验证。

2. **实现独立可仿真的 ATU 模块**
   - 接口：逻辑行号 → 物理地址；pivot 更新接口；
   - 支持 P-Vector 初始化与随机读写；
   - 在 testbench 中验证：
     - 不做真实行交换，只更新 P-Vector；
     - 通过 ATU 访问数据，与“真交换行”的结果完全一致。

3. **实现最小版本的 Front Scheduler**
   - 先支持线性 Front 序列（无复杂 DAG），  
     完成：解析 Task Descriptor → 配置 HPU/ATU → 启动 Panel → 等待完成；
   - 在此基础上逐步加入 DAG 依赖管理。

4. **实现精简版 Panel-GEPP + TRSM 流水**
   - 固定矩阵/Panel 尺寸，简化 corner case；
   - 所有行访问必须通过 ATU 完成；
   - 与 HPU 集成：分解过程中真正使用 pivot 事件。

5. **实现 Kernel Pipeline Controller 与多 Front 波前调度**
   - 管理 Panel/TRSM/TPU 的互相重叠；
   - 支持至少 2~4 个 Front 的波前并行仿真。

---

### 6.2 验证与实验（专利中“有益效果”的数据来源）

1. **功能正确性**
   - 与软件 GOLDEN MODEL 对比：
     - 小型矩阵（4×4, 8×8, 16×16…）的 LU/Cholesky 分解结果；
     - 前代/回代（Solve Phase）结果；
   - 验证 pivot 策略切换（CALU/Threshold）不会破坏数值正确性。

2. **性能与资源对比实验**
   - **零拷贝 vs 真实行交换**：
     - 统计访存次数、DDR 访问量、时钟周期；
   - **单模式 HPU vs 双模式混合 HPU**：
     - 在不同稀疏度 front 上的扫描元素数、fill-in proxy；
   - **串行 Front 调度 vs 多波前硬件调度**：
     - 统计总循环次数、内核利用率。

3. **资源开销（FPGA 上的 LUT/FF/BRAM 利用）**
   - 给出 HPU、ATU、Scheduler 各自的资源占用；
   - 论证在合理资源成本下换取显著性能收益。

---

### 6.3 文档与图纸（专利撰写需要准备的材料）

1. **系统架构图**
   - 显示 HPU、ATU、Front Scheduler、Kernel Pipeline、TPU、DDR 等模块及连线。

2. **模块内部结构示意图**
   - HPU：比较树、电路结构和 mode 控制路径；
   - ATU：P-Vector 存储、查询路径、更新路径；
   - Scheduler：依赖表、ready 队列、issue 逻辑。

3. **关键时序/流程图**
   - 单个 Front 从接收任务 → Panel 分解 → pivot → Schur 更新 → Front 完成；
   - pivot 事件发生时，HPU/ATU/内核三者之间的信号交互。

4. **实验结果图/表格**
   - 性能、资源、访存量对比；
   - 在专利中写成“实施例的效果对比”。

---

## 7. 后续可拓展的从属权利要求方向（可选）

为了以后扩展，可以在专利中预留一些从属权利要求，例如：

1. HPU 中的具体比较树结构（k-ary tree、流水级数等）；
2. ATU 中的 P-Vector 存储形式（多级 TLB 风格、分块映射等）；
3. Front Scheduler 的具体 issue 策略（基于 front 权重、基于带宽预算等）；
4. 支持不同分解算法（LU / Cholesky / LDL^T）的模式扩展；
5. 与不同类型运算阵列（TPU、SIMD 阵列、向量处理器）的适配方式。

这些内容可以在毕设后期或投稿论文时慢慢补充，为专利增加弹性空间。

---

## 8. 总结：一句话概括你要做的事

你这个专利可以概括为：

> **设计并实现一套“HPU+ATU+硬件调度器+多核流水”的稀疏多波前分解专用控制与数据路径 IP，  
> 通过硬件化主元选择、零拷贝行置换、理解消去树依赖的前沿调度，  
> 让 TPU/稠密阵列能够高效地执行原本高度不规则的稀疏分解。**

- 